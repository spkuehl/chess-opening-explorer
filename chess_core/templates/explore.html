{% extends "base.html" %}

{% block title %}Explore openings â€“ Chess Explorer{% endblock %}

{% block content %}
<style>
  .form-filters { font-size: 0.85rem; }
</style>
<div class="flex-shrink-0 flex items-center">
  <h1
      style="-webkit-text-fill-color: #94949493; -webkit-text-stroke: 1px rgba(59, 130, 246, 0.7); paint-order: stroke fill;"
    >
    Chess Opening Database Explorer
  </h1>
</div>

{% if validation_error_message %}
<p role="alert">Invalid filters: {{ validation_error_message }} Using defaults.</p>
{% endif %}

<details class="filter-details" open>
  <summary>Filters</summary>
  <form
    method="get"
    action="{% url 'explore' %}"
    hx-get="{% url 'explore' %}"
    hx-target="#explore-results"
    hx-swap="innerHTML"
    hx-trigger="input delay:200ms from:form"
  >
    <fieldset class="grid" style="--pico-grid-columns: 2">
      <p>
        <label class="form-filters" for="eco_code">ECO code</label>
        <input class="form-filters" type="text" name="eco_code" id="eco_code" value="{{ form_data.eco_code|default:'' }}" placeholder="e.g. B20">
      </p>
      <p>
        <label class="form-filters" for="opening_name">Opening name</label>
        <input class="form-filters" type="text" name="opening_name" id="opening_name" value="{{ form_data.opening_name|default:'' }}" placeholder="e.g. Queen's Gambit">
      </p>
      <p>
        <label class="form-filters" for="date_from">Date from</label>
        <input class="form-filters" type="date" name="date_from" id="date_from" value="{{ form_data.date_from|default:'' }}">
      </p>
      <p>
        <label class="form-filters" for="date_to">Date to</label>
        <input class="form-filters" type="date" name="date_to" id="date_to" value="{{ form_data.date_to|default:'' }}">
      </p>
      <p>
        <label class="form-filters" for="threshold">Min games</label>
        <input class="form-filters" type="number" name="threshold" id="threshold" value="{{ form_data.threshold|default:'10' }}" min="1">
      <p>
        <label class="form-filters" for="opening_threshold">Min ply <small>(half moves)</small></label>
        <input class="form-filters" type="number" name="opening_threshold" id="opening_threshold" value="{{ form_data.opening_threshold|default:'3' }}" min="1" placeholder="3">
      </p>
    </fieldset>
  </form>
</details>

<div id="explore-results">
  {% include "partials/explore_results.html" with chart_items=chart_items chart_message=chart_message stats=stats total=total sort_urls=sort_urls column_links=column_links current_sort_by=current_sort_by current_order=current_order pagination=pagination %}
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
(function () {
  function initWinRateChart() {
    var dataEl = document.getElementById('win-rate-chart-data');
    var canvas = document.getElementById('win-rate-chart');
    if (!canvas || !dataEl) return;
    var raw = dataEl.textContent;
    var items = raw ? JSON.parse(raw) : [];
    if (window.winRateChart && typeof window.winRateChart.destroy === 'function') {
      window.winRateChart.destroy();
      window.winRateChart = null;
    }
    if (!items || items.length === 0) return;
    var labels = items.map(function (d) { return d.period_label; });
    var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    var blackBorder = isDark ? '#374151' : '#111827';
    var blackBackground = isDark ? 'rgba(55, 65, 81, 0.5)' : 'rgba(17, 24, 39, 0.7)';
    window.winRateChart = new Chart(canvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'White wins', data: items.map(function (d) { return d.white_pct; }), borderColor: '#e5e7eb', backgroundColor: 'rgba(229, 231, 235, 0.5)', fill: true, stack: 'stack0' },
          { label: 'Draws', data: items.map(function (d) { return d.draw_pct; }), borderColor: '#9ca3af', backgroundColor: 'rgba(156, 163, 175, 0.5)', fill: true, stack: 'stack0' },
          { label: 'Black wins', data: items.map(function (d) { return d.black_pct; }), borderColor: blackBorder, backgroundColor: blackBackground, fill: true, stack: 'stack0' }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true },
          y: { stacked: true, min: 0, max: 100 }
        }
      }
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWinRateChart);
  } else {
    initWinRateChart();
  }
  document.body.addEventListener('htmx:afterSwap', function (ev) {
    if (ev.detail && ev.detail.target && ev.detail.target.id === 'explore-results') {
      setTimeout(function () {
        initWinRateChart();
        if (window.winRateChart) {
          setTimeout(function () { window.winRateChart.resize(); }, 50);
        }
      }, 0);
    }
  });
})();
</script>
{% endblock %}
